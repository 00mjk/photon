From 8ff71a9c80cfcf64c54d4ae938c644b1b1ea19fb Mon Sep 17 00:00:00 2001
From: Nick Clifton <nickc@redhat.com>
Date: Tue, 18 Sep 2018 16:54:07 +0100
Subject: [PATCH 1/1] Add a warning to the bfd library for when it encounters
 an ELF file with an invalid section size.

        PR 23657
        * elfcode.h (elf_swap_shdr_in): Generate a warning message if an
        ELF section has contents and size larger than the file size.
---
 bfd/ChangeLog | 6 ++++++
 bfd/elfcode.h | 8 ++++++++
 2 files changed, 14 insertions(+)

diff --git a/ChangeLog b/ChangeLog
index dcf12bb..851d02e 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+2018-09-18  Nick Clifton  <nickc@redhat.com>
+
+	PR 23657
+	* elfcode.h (elf_swap_shdr_in): Generate a warning message if an
+	ELF section has contents and size larger than the file size.
+
 2014-05-14  Sandra Loosemore  <sandra@codesourcery.com>
 
 	* configure.ac (target_makefile_frag): Set for nios2-*-elf*.
diff --git a/bfd/elfcode.h b/bfd/elfcode.h
index ec53c3b..02531c9 100644
--- a/bfd/elfcode.h
+++ b/bfd/elfcode.h
@@ -314,6 +314,14 @@ elf_swap_shdr_in (bfd *abfd,
     dst->sh_addr = H_GET_WORD (abfd, src->sh_addr);
   dst->sh_offset = H_GET_WORD (abfd, src->sh_offset);
   dst->sh_size = H_GET_WORD (abfd, src->sh_size);
+  /* PR 23657.  Check for invalid section size, in sections with contents.
+     Note - we do not set an error value here because the contents
+     of this particular section might not be needed by the consumer.  */
+  if (dst->sh_type != SHT_NOBITS
+      && ((abfd->my_archive != NULL && !bfd_is_thin_archive (abfd->my_archive)) ? dst->sh_size > arelt_size (abfd) : dst->sh_size > bfd_get_size(abfd)))
+    _bfd_error_handler
+      (_("warning: %pB has a corrupt section with a size (%" BFD_VMA_FMT "x) larger than the file size"),
+       abfd, dst->sh_size);
   dst->sh_link = H_GET_32 (abfd, src->sh_link);
   dst->sh_info = H_GET_32 (abfd, src->sh_info);
   dst->sh_addralign = H_GET_WORD (abfd, src->sh_addralign);
