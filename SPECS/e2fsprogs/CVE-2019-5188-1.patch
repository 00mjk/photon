From 8dd73c149f418238f19791f9d666089ef9734dff Fri Dec 20 00:00:00 2019
From: Theodore Ts'o <tytso@mit.edu>
Date: Thu, 19 Dec 2019 19:37:34 -0500
Subject: e2fsck: abort if there is a corrupted directory block when rehashing
Addresses: CVE-2019-5188
--- a/e2fsck/rehash.c	2020-01-29 14:10:12.617920725 +0530
+++ b/e2fsck/rehash.c	2020-01-29 14:20:50.341898122 +0530
@@ -129,6 +129,10 @@ static int fill_dir_block(ext2_filsys fs
 		dir_offset += rec_len;
 		if (dirent->inode == 0)
 			continue;
+		if ((dirent->name_len) == 0) {
+			fd->err = EXT2_ET_DIR_CORRUPTED;
+			return BLOCK_ABORT;
+		}
 		if (!fd->compress && ((dirent->name_len&0xFF) == 1) &&
 		    (dirent->name[0] == '.'))
 			continue;
@@ -367,6 +371,11 @@ static int duplicate_search_and_fix(e2fs
 		}
 		memcpy(new_name, ent->dir->name, ent->dir->name_len & 0xFF);
 		new_len = ent->dir->name_len;
+		if (new_len == 0) {
+			 /* should never happen */
+			ext2fs_unmark_valid(fs);
+			continue;
+		}
 		mutate_name(new_name, &new_len);
 		for (j=0; j < fd->num_array; j++) {
 			if ((i==j) ||

