From 71ba13755337e19c9a826dfc874562a36e1b24d3 Fri Dec 20 00:00:00 2019
From: Theodore Ts'o <tytso@mit.edu>
Date: Thu, 19 Dec 2019 19:37:34 -0500
Subject: e2fsck: don't try to rehash a deleted directory
--- a/e2fsck/rehash.c	2020-01-29 15:24:14.417763293 +0530
+++ b/e2fsck/rehash.c	2020-01-29 15:28:30.981754200 +0530
@@ -951,6 +960,8 @@ void e2fsck_rehash_directories(e2fsck_t
 			if (!ext2fs_u32_list_iterate(iter, &ino))
 				break;
 		}
+		if (!ext2fs_test_inode_bitmap2(ctx->inode_dir_map, ino))
+			continue;

 		pctx.dir = ino;
 		if (first) {
--- a/e2fsck/pass1b.c	2020-01-29 15:24:26.621762861 +0530
+++ b/e2fsck/pass1b.c	2020-01-29 15:29:13.789752682 +0530
@@ -678,6 +678,10 @@ static void delete_file(e2fsck_t ctx, ex
 		fix_problem(ctx, PR_1B_BLOCK_ITERATE, &pctx);
 	if (ctx->inode_bad_map)
 		ext2fs_unmark_inode_bitmap2(ctx->inode_bad_map, ino);
+	if (ctx->inode_reg_map)
+		ext2fs_unmark_inode_bitmap2(ctx->inode_reg_map, ino);
+	ext2fs_unmark_inode_bitmap2(ctx->inode_dir_map, ino);
+	ext2fs_unmark_inode_bitmap2(ctx->inode_used_map, ino);
 	ext2fs_inode_alloc_stats2(fs, ino, -1, LINUX_S_ISDIR(dp->inode.i_mode));
 	quota_data_sub(ctx->qctx, &dp->inode, ino,
 		       pb.dup_blocks * fs->blocksize);

