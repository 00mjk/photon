From b0894088b680666035a3418326e13bc99d4fed49 Mon Sep 17 00:00:00 2001
From: Philippe Duveau <pduveau@users.noreply.github.com>
Date: Tue, 24 Sep 2019 20:45:25 +0200
Subject: [PATCH] Out of bounds issue

Add a new sanity check after determining the level len.
---
 contrib/pmdb2diag/pmdb2diag.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/contrib/pmdb2diag/pmdb2diag.c b/contrib/pmdb2diag/pmdb2diag.c
index 2b59163012..5810eb4dfe 100644
--- a/contrib/pmdb2diag/pmdb2diag.c
+++ b/contrib/pmdb2diag/pmdb2diag.c
@@ -134,6 +134,10 @@ CODESTARTparse2
 		ABORT_FINALIZE(0);
 	}
 
+	/* let recheck with the real level len */
+	if(pMsg->iLenRawMsg - (int)pMsg->offAfterPRI < pInst->levelpos+lvl_len)
+		ABORT_FINALIZE(RS_RET_COULD_NOT_PARSE);
+
 	DBGPRINTF("db2parse Level %d\n", pMsg->iSeverity);
 
 	end = (char*)pMsg->pszRawMsg + pMsg->iLenRawMsg ;
