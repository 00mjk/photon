From 310eac803c07ea89f63ccc294b14b613e44969ff Mon Sep 17 00:00:00 2001
From: James Antill <james@and.org>
Date: Mon, 18 Feb 2013 16:30:18 -0500
Subject: [PATCH] Auto expire caches on repo errors.

---
 yum/yumRepo.py |  3 ---
 yummain.py     | 15 +++++++++++++++
 2 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/yum/yumRepo.py b/yum/yumRepo.py
index e5e9ece..7328f5a 100644
--- a/yum/yumRepo.py
+++ b/yum/yumRepo.py
@@ -816,9 +816,6 @@ class YumRepository(Repository, config.RepoConf):
                                     )
             except URLGrabError, e:
                 errstr = "failed to retrieve %s from %s\nerror was %s" % (relative, self.id, e)
-                if self.mirrorurls:
-                    errstr +="\n  You could try running: yum clean expire-cache"
-                    errstr +="\n  To get a new set of mirrors."
                 if e.errno == 256:
                     raise Errors.NoMoreMirrorsRepoError, errstr
                 else:
diff --git a/yummain.py b/yummain.py
index a9f001b8..ac94f656 100755
--- a/yummain.py
+++ b/yummain.py
@@ -126,6 +126,11 @@ def rpmdb_warn_checks():
         result, resultmsgs = base.doCommands()
     except plugins.PluginYumExit, e:
         return exPluginExit(e)
+    except Errors.RepoError, e:
+        result = 1
+        resultmsgs = [exception2msg(e)]
+        # For RepoErrors ... help out by forcing new repodata next time.
+        base.cleanExpireCache()
     except Errors.YumBaseError, e:
         result = 1
         resultmsgs = [exception2msg(e)]
@@ -167,6 +172,11 @@ def rpmdb_warn_checks():
         (result, resultmsgs) = base.buildTransaction() 
     except plugins.PluginYumExit, e:
         return exPluginExit(e)
+    except Errors.RepoError, e:
+        result = 1
+        resultmsgs = [exception2msg(e)]
+        # For RepoErrors ... help out by forcing new repodata next time.
+        base.cleanExpireCache()
     except Errors.YumBaseError, e:
         result = 1
         resultmsgs = [exception2msg(e)]
@@ -209,6 +219,11 @@ def rpmdb_warn_checks():
         return_code = base.doTransaction()
     except plugins.PluginYumExit, e:
         return exPluginExit(e)
+    except Errors.RepoError, e:
+        result = 1
+        resultmsgs = [exception2msg(e)]
+        # For RepoErrors ... help out by forcing new repodata next time.
+        base.cleanExpireCache()
     except Errors.YumBaseError, e:
         return exFatal(e)
     except KeyboardInterrupt:
